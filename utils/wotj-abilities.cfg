#textdomain wesnoth-War_of_the_Jewel

####################################################################### WEAPON ABILITIES ################################################

#define WEAPON_SPECIAL_UNERRING

    [chance_to_hit]
        id=unerring
        name= _ "unerring"
        description= _ "This attack always hits, be it in offense or in defence."
        value=100
        cumulative=no
    [/chance_to_hit]
#enddef

#define SPECIAL_NOTES_UNERRING
_"This attack always hits, be it in offense or in defence."#enddef

#define WEAPON_SPECIAL_GREATPLAGUE
    # Canned definition of the Plague ability to be included in a
    # [specials] clause.
    [plague]
        id=greatplague
        name= _ "greater plague"
        description= _ "When a unit is killed by a Greater Plague attack, that unit is replaced with a Soulless on the same side as the unit with the Greater Plague attack. This doesn’t work on Undead or units in villages."
        type=Soulless
    [/plague]
#enddef

#define SPECIAL_NOTES_GREATPLAGUE
_"When a unit is killed by a Greater Plague attack, that unit is replaced with a Soulless on the same side as the unit with the Greater Plague attack. This doesn't work on Undead or units in villages."#enddef

#define WEAPON_SPECIAL_SHOCK
    # Canned definition of the Shock ability to be included in a
    # [specials] clause.
    [attacks]
        id=shock
        name= _ "Shock"
        name_inactive= _ "Shock"
        description= _ "When this attack is used on offense, the opponent will retaliate with one less strike than normally, to a minimum of one strike."
        description_inactive= _ "When this attack is used on offense, the opponent will retaliate with one less strike than normally, to a minimum of one strike."
        sub=1
        active_on=offense
        apply_to=opponent
        [filter_base_value]
            greater_than=1
        [/filter_base_value]
    [/attacks]
#enddef

#define WEAPON_SPECIAL_DEADWHIRLWIND
    [attacks]
        id=dead_whirlwind
        name= _ "whirlwind"
        name_inactive= _ "whirlwind"
        description= _ "When this attack is used, all units adjacent the attacker take the damage."
        description_inactive= _ "When this attack is used, all units adjacent the attacker take the damage."
        apply_to=opponent
    [/attacks]
#enddef

#define WEAPON_SPECIAL_LIFE_CONSUMER
    [dummy]
        id=weapon_life_consumer
        name= _ "life consumer"
        name_inactive= _ "life consumer"
        description= _ "The power needed for this attack is so great that it causes the unit to lose 16 hp, and even cause its death if its life reaches 0 or below."
        description_inactive= _ "The power needed for this attack is so great that it causes the unit to lose 16 hp, and even cause its death if its life reaches 0 or below."
        apply_to=self
    [/dummy]
#enddef

#define SPECIAL_NOTES_LIFE_CONSUMER
_ "The power needed for this attack is so great that it causes the unit to lose 16 hp, and even cause its death if its life reaches 0 or below."#enddef

#define WEAPON_SPECIAL_LESSER_LIFE_CONSUMER
    [dummy]
        id=weapon_lesser_life_consumer
        name= _ "lesser life consumer"
        name_inactive= _ "lesser life consumer"
        description= _ "The power needed for this attack is so great that it causes the unit to lose 8 hp, but never killing it."
        description_inactive= _ "The power needed for this attack is so great that it causes the unit to lose 8 hp, but never killing it."
        apply_to=self
    [/dummy]
#enddef

#define WEAPON_SPECIAL_ATTACK_ONLY
    [attacks]
        id=attack_only
        name= _ "attack only"
        name_inactive= _ "attack only"
        description= _ "This weapon will never be used on defense."
        description_inactive= _ "This weapon will never be used on defense."
        value=0
        apply_to=self
        active_on=defense
        defense_weight=0
    [/attacks]

#enddef

#define SPECIAL_NOTES_LESSER_LIFE_CONSUMER
_ "The power needed for this attack is so great that it causes the unit to lose 8 hp, and even cause its death if its life reaches 0 or below."#enddef

#define WEAPON_SPECIAL_WHIRLWIND
    [attacks]
        id=whirlwind
        name= _ "whirlwind"
        name_inactive= _ "whirlwind"
        description= _ "When this attack is used, all units adjacent the attacker take the damage."
        description_inactive= _ "When this attack is used, all units adjacent the attacker take the damage."
        apply_to=opponent
    [/attacks]
#enddef

#define SPECIAL_NOTES_WHIRLWIND
_ "When this attack is used, all units adjacent the attacker take the damage, and cannot be countered."#enddef

#define WEAPON_SPECIAL_COUNTER
    [chance_to_hit]
        id=counter
        name= _ "counter"
        description= _ "When used defensively, this attack always has at least a 60% chance to hit."
        name_inactive= _ "counter"
        description_inactive= _ "When used defensively, this attack always has at least a 60% chance to hit."
        value=60
        cumulative=yes
        active_on=defense
    [/chance_to_hit]
#enddef

#define SPECIAL_NOTES_COUNTER
_"When used defensively, this attack always has at least a 60% chance to hit."#enddef

#define WEAPON_SPECIAL_EXPLOSIVE
    [damage]
        id=explosive
        name= _ "explosive"
#ifver WESNOTH_VERSION >= 1.11.2
        description= _ "When this attack is used, all units adjacent to the target take 75% of the damage, allies included, and even those behind them will take a few if the damage is sufficiently high."
#else
        description= _ "Explosive damage:
When this attack is used, all units adjacent to the target take 75% of the damage, allies included, and even those behind them will take a few if the damage is sufficiently high."
#endif
    [/damage]
#enddef

#define SPECIAL_NOTES_EXPLOSIVE
_"When this attack is used, all units adjacent to the target take 75% of the damage, allies included, and even those behind them will take a few if the damage is sufficiently high."#enddef

#define WEAPON_SPECIAL_PICKPOCKET

    # Canned definition of the pickpocket ability to be included in a

    # [specials] clause.
    # dummy weapon special used to describe the effect to the user
    # and filter on special's id
    [dummy]
        id=weapon_pickpocket
        name= _ "pickpocket"
        name_inactive= _ "pickpocket"
        description= _ "Gain money for attacking your foe. Each strike scores you two gold."
        description_inactive= _ "Gain money for attacking your foe. Each strike scores you two gold."
        apply_to=opponent
    [/dummy]
#enddef

#define WEAPON_SPECIAL_SHOCK
    # Canned definition of the Shock ability to be included in a
    # [specials] clause.
    [attacks]
        id=shock
        name= _ "shock"
        name_inactive= _ "shock"
        description= _ "When this attack is used on offense, the opponent will retaliate with one less strike than normally, to a minimum of one strike."
        description_inactive= _ "When this attack is used on offense, the opponent will retaliate with one less strike than normally, to a minimum of one strike."
        sub=1
        active_on=offense
        apply_to=opponent
        [filter_base_value]
            greater_than=1
        [/filter_base_value]
    [/attacks]
#enddef

#define SPECIAL_NOTES_SHOCK
_"When this attack is used on offense, the opponent will retaliate with one less strike than normally, to a minimum of one strike."#enddef

#define WEAPON_SPECIAL_DAZE
    [dummy]
        id=daze
        name= _ "daze"
        description= _ "When hit with this attack, an enemy suffers a 10% penalty both to their defense and chance to hit for one turn. Other specials that affect chance to hit (e.g. magical and marksman) take precedence over this special.

Magical attacks will still have a 70% chance to hit.
Marksman attacks are only affected if the chance to hit is greater than 60%."
    [/dummy]
#enddef

#define SPECIAL_NOTES_DAZE
_" This unit can daze its enemies, reducing their accuracy and defense until they end a turn."#enddef

################################################################# HALO ABILITIES ########################################################

#define ABILITY_OBSCURES
    # Canned definition of the Obscures ability to be included in an
    # [abilities] clause.
    [illuminates]
        id=obscure
        value=-25
        min_value=-25
        cumulative=no
        name= _ "obscures"
        female_name= _ "female^obscures"
        description=_ "This unit darkens the surrounding area, making chaotic units fight better, and lawful units fight worse.

Any units adjacent to this unit will fight as if it were dusk when it is day, and as if it were night when it is dusk."
        affect_self=yes
    [/illuminates]
#enddef

#define SPECIAL_NOTES_OBSCURES
    _"This unit darkens the surrounding area, making chaotic units fight better, and lawful units fight worse.

Any units adjacent to this unit will fight as if it were dusk when it is day, and as if it were night when it is dusk."#enddef

#define ABILITY_TERROR_LEVEL_3
    [leadership]
        id=terror
        value=-60
        cumulative=no
        {__ABILITY_TSTRING_TERROR}
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-45
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-30
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-15
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=3
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_TERROR_LEVEL_5
    [leadership]
        id=terror
        value=-90
        cumulative=no
        {__ABILITY_TSTRING_TERROR}
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-75
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-50
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-35
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=3
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=terror
        value=-15
        cumulative=no
        affect_self=no
        affect_allies=no
        affect_enemies=yes
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=4
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define __ABILITY_TSTRING_TERROR
    name= _ "terror"
    description= _ "This unit can frighten enemy units that are next to it, making them fight worse.

Adjacent enemy units of lower level will do less damage in battle. When an enemy unit of the same or lower level is adjacent and engages in combat, its attacks do 15% less damage times the difference in their levels + 15%."
#enddef

#define SPECIAL_NOTES_TERROR
_ " This unit can frighten enemy units that are next to it, making them fight worse." #enddef

#define ABILITY_PROTECTION
    [resistance]
        id=protection
        add=20
        max_value=50
        apply_to=blade,pierce,impact,fire,cold,arcane
        name= _ "protection"
        description= _ "Adjacent units of level 1 or below from this side receive a +20% bonus to all resistances (up to a maximum of 50%)."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
                [or]
                    level=1
                [/or]
            [/filter]
        [/affect_adjacent]
    [/resistance]
#enddef

#define SPECIAL_NOTES_PROTECTION
_ "This unit can protect those of level 0 and 1 around them, granting them extra resistances."#enddef

#define ABILITY_INSPIRE_LEVEL_2
    # Canned definition of the Inspire (level 3) ability to be included in an
    # [abilities] clause.
    [leadership]
        id=inspire_0
        value=50
        cumulative=no
        name= _ "inspire"
        description= _ "This unit can inspire own L0, L1 or L2 units that are next to it, making them fight better. Adjacent own units of L2 will do 15% more damage; L1 will do 25% more, and L0 units will do 50% more."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=inspire_1
        value=25
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=inspire_2
        value=15
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define ABILITY_INSPIRE_LEVEL_3
    # Canned definition of the Inspire (level 3) ability to be included in an
    # [abilities] clause.
    [leadership]
        id=inspire_0
        value=75
        cumulative=no
        name= _ "inspire"
        description= _ "This unit can inspire own L0, L1, L2, or L3 units that are next to it, making them fight better. Adjacent own units of L3 will do 15% more damage; L2 units will do 25% more, L1 will do 50% more, and L0 units will do 75% more."
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=inspire_1
        value=50
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=inspire_2
        value=25
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=2
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=inspire_3
        value=15
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=3
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define SPECIAL_NOTES_INSPIRE
_" The presence of this unit inspires own units next to it to deal more damage in combat, though this only applies to units of lower or equal level."#enddef

#define ABILITY_INSPIRE
    [leadership]
        id=leadership
        value=15
        cumulative=no
        name= _ "inspire"
        description= _ "This unit can inspire friendly units that are next to it, making them fight better.

Adjacent friendly L1 units will do 15% more damage in battle, while L0 units will fight 25% better"
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=1
                [not]
                    type=Messenger
                [/not]
            [/filter]
        [/affect_adjacent]
    [/leadership]
    [leadership]
        id=leadership
        value=25
        cumulative=no
        affect_self=no
        [affect_adjacent]
            adjacent=n,ne,se,s,sw,nw
            [filter]
                level=0
            [/filter]
        [/affect_adjacent]
    [/leadership]
#enddef

#define SPECIAL_NOTES_INSPIRE
_" The ability of this unit to inspire its allies enables adjacent units of the same side to deal more damage in combat, though this does not apply to other Messengers or units of higher level." #enddef

#define SPECIAL_NOTES_SHIELDWALL
_"This unit gains a +10% bonus to defense when another unit with the same ability is adjacent to it. However, this cannot raise the unit's defense above 70%." #enddef

################################################################# SELF-AFFECTING ABILITIES #########################################

#define ABILITY_MOUNTAIN_AMBUSH
    # Canned definition of the Ambush ability to be included in an
    # [abilities] clause.
    [hides]
        id=mountain_ambush
        name= _ "mountain ambush"
        female_name= _ "female^mountain ambush"
        name_inactive= _ "mountain ambush"
        female_name_inactive= _ "female^mountain ambush"
        description= _ "This unit can hide in mountainous terrain, and remain undetected by its enemies.

Enemy units cannot see this unit while it is on a mountain, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "This unit can hide in mountainous terrain, and remain undetected by its enemies.

Enemy units cannot see this unit while it is on a mountain, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter]
            [filter_location]
                terrain=Mm,Md,Ms
            [/filter_location]
        [/filter]
    [/hides]
#enddef

#define SPECIAL_NOTES_MOUNTAIN_AMBUSH
_" On mountainous terrain, this unit's ambush skill renders it invisible to enemies unless it is immediately adjacent or has revealed itself by attacking."#enddef

#define ABILITY_FOREST_WATER_AMBUSH

    [hides]
        id=forest_water_ambush
        name= _ "forest and water ambush"
        female_name= _ "female^forest and water ambush"
        name_inactive= _ "forest and water ambush"
        female_name_inactive= _ "female^forest and water ambush"
        description= _ "This unit can hide in both forest and water, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in either forest or water, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        description_inactive= _ "This unit can hide in both forest and water, and remain undetected by its enemies.

Enemy units cannot see this unit while it is in forest, except if they have units next to it. Any enemy unit that first discovers this unit immediately loses all its remaining movement."
        affect_self=yes
        [filter]
            [filter_location]
                terrain=*^F*,Wwg,Ww,Wwt,Wwr,Wwrt,Ss,Sm,Ww^Ewl,Ww^Ewf,Gg^Bw/,Gg^Bw|,Gg^Bw\,Gg^Bw/r,Gg^Bw|r,Gg^Bw\r,Gg^Bsb/,Gg^Bsb|,Gg^Bsb\
            [/filter_location]
        [/filter]
    [/hides]
#enddef

#define SPECIAL_NOTES_FOREST_WATER_AMBUSH
_" On forested or aquatic terrain, this unit's ambush skill renders it invisible to enemies unless it is immediately adjacent or has revealed itself by attacking."#enddef

#define ABILITY_DISENGAGE
    [dummy]
        id=disengage
        name= _ "disengage"
        female_name= _ "female^disengage"
        description= _ "If this unit doesn’t move before attacking, it will retain its movement points after the attack."
    [/dummy]
#enddef

#define SPECIAL_NOTES_DISENGAGE
_" On forested or aquatic terrain, this unit's ambush skill renders it invisible to enemies unless it is immediately adjacent or has revealed itself by attacking."#enddef

#define FORMATION ID GREATER_THAN COUNT
    [chance_to_hit]
        id={ID}
        apply_to=opponent
        sub=10
        [filter_base_value]
            greater_than_equal_to={GREATER_THAN}
        [/filter_base_value]
        [filter_self]
            [filter_adjacent]
                is_enemy=no
                count={COUNT}
                ability=formation
            [/filter_adjacent]
        [/filter_self]
    [/chance_to_hit]
#enddef

#define ABILITY_SHIELDWALL
    [dummy]
        id=formation
        name= _ "shieldwall"
        female_name= _ "female^shieldwall"
        description= _ "This unit gains a +10% bonus to defense when another unit with the same ability is adjacent to it. However, this cannot raise the unit’s defense above 70%."
        [filter]
            [filter_adjacent]
                ability=formation
                is_enemy=no
                count=1-5
            [/filter_adjacent]
        [/filter]
    [/dummy]
    {FORMATION formation1 40 1-5}
    {FORMATION formation2 50 2-5}
    {FORMATION formation3 60 3-5}
    {FORMATION formation4 70 4-5}
    {FORMATION formation5 80 5}
#enddef

#define WEAPON_SPECIALS_EVENTS

    ############################################################################ EXPLOSIVE ##################################################

    [event]
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=explosive
        [/filter_attack]
        {INCORPORATE_EFFECTS}
        [harm_unit]
            [filter]
                [filter_adjacent]
                    x,y=$x2,$y2
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2,$x1,$y1
                [/not]
                [enemy_of]
                    side=$x1,$y1
                [/enemy_of]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$($($damage*3)/4-4)
            damage_type=$weapon.type
            fire_event=yes
            experience=no
        [/harm_unit]
        [if]
            [variable]
                name=damage
                greater_than=24	# If the damage is high enough, the range is increased.
            [/variable]
            [then]
                [harm_unit]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=1
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=2
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [enemy_of]
                            side=$x1,$y1
                        [/enemy_of]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]

                    amount=$($($damage*3)/4-18)
                    damage_type=$weapon.type
                    fire_event=yes
                    experience=no
                    animate=no
                [/harm_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=damage
                greater_than=48		# If the damage is extremely high, the range is increased even more.
            [/variable]
            [then]
                [harm_unit]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=2
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=3
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [enemy_of]
                            side=$x1,$y1
                        [/enemy_of]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]

                    amount=$($($damage)/2-24)
                    damage_type=$weapon.type
                    fire_event=yes
                    experience=no
                    animate=no
                [/harm_unit]
            [/then]
        [/if]
        [if]
            [variable]
                name=damage
                greater_than=108		# If the damage is higher than most common attacks can get, the range is increased even even more.
            [/variable]
            [then]
                [harm_unit]
                    [filter]
                        [filter_location]
                            # Exclude the units that just received the damage.
                            [not]
                                x,y=$x2,$y2
                                radius=3
                            [/not]
                            # Include the remaining units within two hexes.
                            [and]
                                x,y=$x2,$y2
                                radius=4s
                                # The blaze cannot go through walls.
                                [filter_radius]
                                    terrain=!,X*,X*^*,*^X*
                                [/filter_radius]
                            [/and]
                        [/filter_location]
                        [enemy_of]
                            side=$x1,$y1
                        [/enemy_of]
                    [/filter]
                    [filter_second]
                        x,y=$x1,$y1
                    [/filter_second]

                    amount=$($($damage)/3-36)
                    damage_type=$weapon.type
                    fire_event=yes
                    experience=no
                    animate=no
                [/harm_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE damage}
    [/event]

    ################################################################## LIFE CONSUMER ###################################################

    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=weapon_life_consumer
        [/filter_attack]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=unit_att_with_life_consumer
            mode=append
        [/store_unit]
        [set_variable]
            name=unit_att_with_life_consumer.variables.life_consumer_has_worked
            value=yes
        [/set_variable]
        [unstore_unit]
            variable=unit_att_with_life_consumer
        [/unstore_unit]
        {CLEAR_VARIABLE unit_att_with_life_consumer}
    [/event]
    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=weapon_life_consumer
        [/filter_attack]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=life_consumer
            mode=append
        [/store_unit]

        [if]
            [variable]
                name=life_consumer.variables.life_consumer_has_worked
                equals=yes
            [/variable]
            [then]
                [harm_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=16
                    kill=yes
                    animate=yes
                    fire_event=yes
                [/harm_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE life_consumer}
    [/event]

    ######################################################################### LESSER LIFE CONSUMER ###########################################

    # event that creates a "lesser life consumer has worked" variable
    # and sets it to "yes" if the attacker hits at least once.
    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=weapon_lesser_life_consumer
        [/filter_attack]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=unit_att_with_lesser_life_consumer
            mode=append
        [/store_unit]
        [set_variable]
            name=unit_att_with_lesser_life_consumer.variables.lesser_life_consumer_has_worked
            value=yes
        [/set_variable]
        [unstore_unit]
            variable=unit_att_with_lesser_life_consumer
        [/unstore_unit]
        {CLEAR_VARIABLE unit_att_with_lesser_life_consumer}
    [/event]
    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=weapon_lesser_life_consumer
        [/filter_attack]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=lesser_life_consumer
            mode=append
        [/store_unit]

        [if]
            [variable]
                name=lesser_life_consumer.variables.lesser_life_consumer_has_worked
                equals=yes
            [/variable]
            [then]
                [harm_unit]
                    [filter]
                        x,y=$x1,$y1
                    [/filter]
                    amount=8
                    kill=no
                    animate=yes
                    fire_event=yes
                [/harm_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE lesser_life_consumer}
    [/event]

    ################################################################################ WHIRLWIND #################################################

    # Event for the Whirlwind special

    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=whirlwind
        [/filter_attack]
        {VARIABLE has_drain 0}      # Notifies the weapon specials
        {VARIABLE has_slow no}
        {VARIABLE has_poison no}
        {FOREACH weapon.specials.damage i}
            [if]
                [variable]
                    name=weapon.specials.drains.id
                    equals=drains
                [/variable]
                [then]
                    {VARIABLE has_drain 1}
                [/then]
            [/if]
        {NEXT i}
        [if]
            [variable]
                name=weapon.specials.poison.id
                equals=poison
            [/variable]
            [then]
                {VARIABLE has_poison yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=weapon.specials.slow.id
                equals=slow
            [/variable]
            [then]
                {VARIABLE has_slow yes}
            [/then]
        [/if]
        [if]
            [variable]
                name=has_drain
                equals=0
            [/variable]
            [else]
                [store_unit]      #We need to know how many units were drained, and what were their resistances
                    [filter]
                        [filter_adjacent]
                            x,y=$x1,$y1
                        [/filter_adjacent]
                        [not]
                            side=$unit.side              #If you want to use it in an era, use side=$unit.side instead
                        [/not]
                        [not]         #The target unit is already hit by the attack
                            x,y=$x2,$y2
                        [/not]
                        [not]          #Undead are undrainable
                            race=undead
                        [/not]
                    [/filter]
                    variable=units
                [/store_unit]
                {VARIABLE healed_amount 0}
                {FOREACH units i}
                    [switch]            #Check the resistances
                        variable=weapon.type
                        [case]
                            value=arcane
                            {VARIABLE_OP healed_amount add "$($units[$i].resistance.arcane*$weapon.damage)"}
                        [/case]
                        [case]
                            value=fire
                            {VARIABLE_OP healed_amount add "$($units[$i].resistance.fire*$weapon.damage)"}
                        [/case]
                        [case]
                            value=cold
                            {VARIABLE_OP healed_amount add "$($units[$i].resistance.cold*$weapon.damage)"}
                        [/case]
                        [case]
                            value=blade
                            {VARIABLE_OP healed_amount add "$($units[$i].resistance.blade*$weapon.damage)"}
                        [/case]
                        [case]
                            value=pierce
                            {VARIABLE_OP healed_amount add "$($units[$i].resistance.pierce*$weapon.damage)"}
                        [/case]
                        [case]
                            value=impact
                            {VARIABLE_OP healed_amount add "$($units[$i].resistance.impact*$weapon.damage)"}
                        [/case]
                    [/switch]
                {NEXT i}
                [store_unit]        #Float the healed amount over the unit, like if it had drained
                    [filter]    #Two numbers will float, the one from the regular hit and one from this
                        x,y=$x1,$y1
                    [/filter]
                    kill=no
                    variable=FLOATING_TEXT_temp
                [/store_unit]
                [unstore_unit]
                    variable=FLOATING_TEXT_temp
                    find_vacant=no
                    red,green,blue=0,255,0
                    text=$($healed_amount/200)         #Operating with huge numbers because rounding is a problem
                [/unstore_unit]
                {CLEAR_VARIABLE FLOATING_TEXT_temp}
                [heal_unit]
                    [filter]
                        x,y=$x1,&y1
                    [/filter]
                    amount=$($healed_amount/200)
                    animate=no
                [/heal_unit]
                {CLEAR_VARIABLE units}
                {CLEAR_VARIABLE healed_amount}
            [/else]
        [/if]
        [harm_unit]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                [not]
                    side=$unit.side             #If you want to use it in an era, use side=$unit.side instead
                [/not]
                [not]             #If you want to use it in an era, use side=$unit.side instead
                    x,y=$x2,$y2
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$weapon.damage
            damage_type=$weapon.type
            fire_event=yes
            experience=no
            poisoned=$has_poison   #We have detected these two effects before
            slowed=$has_slow
        [/harm_unit]
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
        {CLEAR_VARIABLE has_drain}
    [/event]

    ######################################################################### DEAD WHIRLWIND ############################################

    # Special thanks to Dugi and trewe ;-)

    [event]
        id=dead_whirlwind_attacker_hits
        name=attacker_hits
        first_time_only=no

        [filter_attack]
            special=dead_whirlwind
        [/filter_attack]

        # check specials

        # add default values (note: 0/1 are not booleans)
        {VARIABLE dead_whirlwind.has_drain no}
        {VARIABLE dead_whirlwind.has_poison no}
        {VARIABLE dead_whirlwind.has_slow no}

        # check if they exist
        # NOTE this covers custom made specials too (where the id is changed)
        [if]
            {VARIABLE_CONDITIONAL weapon.specials.drains.id not_equals $empty_var}
            [then]
                {VARIABLE dead_whirlwind.has_drain yes}
            [/then]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL weapon.specials.poison.id not_equals $empty_var}
            [then]
                {VARIABLE dead_whirlwind.has_poison yes}
            [/then]
        [/if]

        [if]
            {VARIABLE_CONDITIONAL weapon.specials.slow.id not_equals $empty_var}
            [then]
                {VARIABLE dead_whirlwind.has_slow yes}
            [/then]
        [/if]

        # store all surrounding enemy units
        [store_unit]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                [not]
                    x,y=$x2,$y2
                [/not]
                [not]
                    [filter_side]
                        [allied_with]
                            side=$unit.side
                        [/allied_with]
                    [/filter_side]
                [/not]
            [/filter]
            variable=units
        [/store_unit]

        # calculate drain
        [if]
            {VARIABLE_CONDITIONAL dead_whirlwind.has_drain equals yes}
            [then]
                {FOREACH units i_temp}
                    # only units which can be drained at all
                    [if]
#ifver WESNOTH_VERSION > 1.11.0
                        {VARIABLE_CONDITIONAL $units[$i_temp].status.undrainable equals yes}
#else
                        {VARIABLE_CONDITIONAL $units[$i_temp].status.not_living equals yes}
#endif
                        [then]
                            {VARIABLE healed_amount "$($units[$i_temp].resistance.$weapon.type*$weapon.damage)"}

                            [floating_text]
                                x,y=$x1,$y1
                                text=_ "<span color='0,255,0'>"+"$($healed_amount/200)"+"</span>"
                            [/floating_text]

                            [heal_unit]
                                [filter]
                                    x,y=$x1,$y1
                                [/filter]
                                amount="$($healed_amount/200)"
                                animate=no # this should be set to yes (and the floating text above removed)
                            [/heal_unit]
                            {CLEAR_VARIABLE healed_amount}
                        [/then]
                    [/if]
                {NEXT i_temp}
            [/then]
        [/if]

        # store time of day
        [store_time_of_day]
            variable=dead_whirlwind.tod
        [/store_time_of_day]

        # harm surrounding units
        [harm_unit]
            [filter]
                [filter_adjacent]
                    x,y=$x1,$y1
                [/filter_adjacent]
                [not]
                    [filter_side]
                        [allied_with]
                            side=$unit.side
                        [/allied_with]
                    [/filter_side]
                [/not]
                [not]
                    x,y=$x2,$y2
                [/not]
            [/filter]
            [filter_second]
                x,y=$x1,$y1
            [/filter_second]
            amount=$weapon.damage
            damage_type=$weapon.type
            alignment=$dead_whirlwind.tod.id
            animate=no # disabled here - it looks ugly
            fire_event=yes
            experience=no
            poisoned=$dead_whirlwind.has_poison
            slowed=$dead_whirlwind.has_slow
        [/harm_unit]

        # replace dead units with a Soulless
        # NOTE for balance purpose attacks_left and moves are set to 0 (like plaque would do)
        {FOREACH units i_temp}
            [if]
                [not]
                    [have_unit]
                        id=$units[$i_temp].id
                    [/have_unit]
                [/not]
                [not]
                    [variable]
                        name=units[$i_temp].status.not_living
                        equals=yes
                    [/variable]
                [/not]
                [then]
                    {GENERIC_UNIT $side_number Soulless $units[$i_temp].x $units[$i_temp].y}
                    [+unit]
                        animate=yes
                        attacks_left=0
                        moves=0
                    [/unit]
                [/then]
            [/if]
        {NEXT i_temp}

        {CLEAR_VARIABLE dead_whirlwind,units}
    [/event]

    ##################################################################### PICKPOCKET ####################################################

    # event that creates a "pickpocket has worked" variable
    # and sets it to "yes" if the attacker hits at least once.
    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=weapon_pickpocket
        [/filter_attack]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=unit_att_with_pickpocket
            mode=append
        [/store_unit]
        [set_variable]
            name=unit_att_with_pickpocket.variables.pickpocket_has_worked
            value=yes
        [/set_variable]
        [unstore_unit]
            variable=unit_att_with_pickpocket
        [/unstore_unit]
        {CLEAR_VARIABLE unit_att_with_pickpocket}
    [/event]
    [event]
        name=attack end
        first_time_only=no
        [filter_attack]
            special=weapon_pickpocket
        [/filter_attack]
        [store_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            variable=pickpocketer
            mode=append
        [/store_unit]
        [store_unit]
            [filter]
                x,y=$x2,$y2
            [/filter]
            variable=pickpocketed
            mode=append
        [/store_unit]
        [if]
            [variable]
                name=pickpocketer.variables.pickpocket_has_worked
                equals=yes
            [/variable]
            [then]
                [gold]
                    side=$side_number
                    amount=2
                [/gold]
                [unstore_unit]
                    variable=pickpocketed
                    text=_ "!"
                    {COLOR_HEAL}
                [/unstore_unit]
            [/then]
        [/if]
        {CLEAR_VARIABLE pickpocketer}
        {CLEAR_VARIABLE pickpocketed}
    [/event]

    ############################################################################# DAZE #################################################################

    [event]
        id=weapon_special_daze_event_1
        name=unit placed
        first_time_only=no

        [filter]
            [not]
                [has_attack]
                    special=enemy_dazed
                [/has_attack]
            [/not]
        [/filter]

        [object]
            silent=yes

            [filter]
                x,y=$x1,$y1
            [/filter]

            [effect]
                apply_to=attack
                [not]
                    special=magical
                [/not]
                [not]
                    special=marksman
                [/not]
                [not]
                    special=enemy_dazed
                [/not]

                [set_specials]
                    mode=append

                    [chance_to_hit]
                        id=enemy_dazed
                        name=""
                        description=""
                        add=10
                        [filter_opponent]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_opponent]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
            [effect]
                apply_to=attack
                special=marksman
                [and]
                    special=poison
                [/and]
                [not]
                    special=enemy_dazed
                [/not]

                # Note: instead of simply appending, we have to use replace and
                # put marksman last because the +10% from daze must be applied
                # first; the other way around, the base value would already be
                # potentially modified by marksman
                [set_specials]
                    mode=replace

                    [chance_to_hit]
                        id=enemy_dazed
                        name=""
                        description=""
                        add=10
                        active_on=offense
                        [filter_base_value]
                            greater_than_equal_to=60
                        [/filter_base_value]
                        [filter_opponent]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_opponent]
                    [/chance_to_hit]
                    {WEAPON_SPECIAL_MARKSMAN}
                    {WEAPON_SPECIAL_POISON}
                    [chance_to_hit]
                        id=enemy_dazed_marksman_defense
                        name=""
                        description=""
                        add=10
                        active_on=defense
                        [filter_opponent]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_opponent]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
            [effect]
                apply_to=attack
                special=marksman
                [not]
                    special=poison
                [/not]
                [not]
                    special=enemy_dazed
                [/not]

                # Note: instead of simply appending, we have to use replace and
                # put marksman last because the +10% from daze must be applied
                # first; the other way around, the base value would already be
                # potentially modified by marksman
                [set_specials]
                    mode=replace

                    [chance_to_hit]
                        id=enemy_dazed
                        name=""
                        description=""
                        add=10
                        active_on=offense
                        [filter_base_value]
                            greater_than_equal_to=60
                        [/filter_base_value]
                        [filter_opponent]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_opponent]
                    [/chance_to_hit]
                    {WEAPON_SPECIAL_MARKSMAN}
                    [chance_to_hit]
                        id=enemy_dazed_marksman_defense
                        name=""
                        description=""
                        add=10
                        active_on=defense
                        [filter_opponent]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_opponent]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
        [/object]
    [/event]

    [event]
        id=weapon_special_daze_event_2
        name=attacker hits
        first_time_only=no

        [filter_attack]
            special=daze
        [/filter_attack]

        [filter_second]
            [not]
                [filter_wml]
                    [status]
                        dazed=yes
                    [/status]
                [/filter_wml]
            [/not]
        [/filter_second]

        {VARIABLE second_unit.status.dazed yes}

        [unstore_unit]
            variable=second_unit
            find_vacant=no
            text= _ "dazed"
            female_text = _ "female^dazed"
            red,green,blue=196,196,128
        [/unstore_unit]

        [object]
            silent=yes

            [filter]
                x,y=$x2,$y2
            [/filter]

            [effect]
                apply_to=attack
                [not]
                    special=magical
                [/not]
                [not]
                    special=marksman
                [/not]
                [not]
                    special=self_dazed
                [/not]

                [set_specials]
                    mode=append

                    [chance_to_hit]
                        id=self_dazed
                        name=""
                        description=""
                        sub=10
                        [filter_self]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_self]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
            [effect]
                apply_to=attack
                special=marksman
                [and]
                    special=poison
                [/and]
                [not]
                    special=self_dazed
                [/not]

                [set_specials]
                    mode=replace

                    [chance_to_hit]
                        id=self_dazed
                        name=""
                        description=""
                        sub=10
                        active_on=offense
                        [filter_base_value]
                            greater_than_equal_to=70
                        [/filter_base_value]
                        [filter_self]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_self]
                    [/chance_to_hit]
                    {WEAPON_SPECIAL_MARKSMAN}
                    {WEAPON_SPECIAL_POISON}
                    [chance_to_hit]
                        id=self_dazed_marksman_defense
                        name=""
                        description=""
                        sub=10
                        active_on=defense
                        [filter_self]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_self]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
            [effect]
                apply_to=attack
                special=marksman
                [not]
                    special=poison
                [/not]
                [not]
                    special=self_dazed
                [/not]

                [set_specials]
                    mode=replace

                    [chance_to_hit]
                        id=self_dazed
                        name=""
                        description=""
                        sub=10
                        active_on=offense
                        [filter_base_value]
                            greater_than_equal_to=70
                        [/filter_base_value]
                        [filter_self]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_self]
                    [/chance_to_hit]
                    {WEAPON_SPECIAL_MARKSMAN}
                    [chance_to_hit]
                        id=self_dazed_marksman_defense
                        name=""
                        description=""
                        sub=10
                        active_on=defense
                        [filter_self]
                            [filter_wml]
                                [status]
                                    dazed=yes
                                [/status]
                            [/filter_wml]
                        [/filter_self]
                    [/chance_to_hit]
                [/set_specials]
            [/effect]
        [/object]
    [/event]

    [event]
        id=weapon_special_daze_event_3
        name=side turn
        first_time_only=no

        [event]
            name=side turn
            delayed_variable_substitution=no

            #{DEBUG_MSG "side $|side_number turn started, clearing daze from side $side_number units"}

            [modify_unit]
                [filter]
                    side=$side_number
                    [filter_wml]
                        [status]
                            dazed=yes
                        [/status]
                    [/filter_wml]
                [/filter]

                [status]
                    dazed=no
                [/status]
            [/modify_unit]
        [/event]
    [/event]

    ############################################################################# DISENGAGE ##################################################################

    [event]
        name=attack end
        first_time_only=no

        [filter]
            ability=disengage

            [not]
                [filter_wml]
                    moves=$this_unit.max_moves
                [/filter_wml]
            [/not]
        [/filter]

        {VARIABLE unit.moves 0}

        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    [/event]

#enddef
